<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0f172a" />
  <title>C150 Equipment Manager (MVP)</title>
  <style>
    :root { --bg:#0f172a; --panel:#111827; --muted:#94a3b8; --text:#e5e7eb; --accent:#60a5fa; --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444; }
    * { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial; background: var(--bg); color: var(--text); }
    body { font-size: 16px; line-height: 1.35; }

    header { position: sticky; top: 0; background: rgba(15,23,42,.9); backdrop-filter: blur(8px); border-bottom: 1px solid #1f2937; z-index: 10; }
    .wrap { max-width: 1100px; margin: 0 auto; padding: 12px 16px; }
    h1 { margin: 6px 0 10px; font-size: 20px; }

    .tabs { display: flex; gap: 8px; overflow-x: auto; -webkit-overflow-scrolling: touch; padding-bottom: 4px; }
    .tab { padding: 10px 12px; border: 1px solid #334155; border-radius: 10px; background:#0b1220; color: var(--muted); cursor: pointer; user-select: none; white-space: nowrap; }
    .tab.active { color: var(--text); border-color: var(--accent); box-shadow: inset 0 0 0 1px var(--accent); }

    main { max-width: 1100px; margin: 0 auto; padding: 16px; }
    section.panel { display: none; background: var(--panel); border: 1px solid #1f2937; border-radius: 12px; padding: 12px; margin-top: 12px; }
    section.panel.active { display: block; }

    .grid { display: grid; gap: 10px; }
    .g2 { grid-template-columns: repeat(2, minmax(0,1fr)); }
    .g3 { grid-template-columns: repeat(3, minmax(0,1fr)); }
    @media (max-width:900px){ .g2, .g3 { grid-template-columns: 1fr; } }

    label { display:block; font-size: 13px; color: var(--muted); margin-bottom: 4px; }
    input, select, textarea { width:100%; padding:12px; border:1px solid #334155; border-radius:12px; background:#0b1220; color:var(--text); }
    input, select, textarea { min-height: 44px; }
    textarea{ min-height: 100px; }

    .row { display:flex; align-items:center; gap:8px; flex-wrap:wrap; }
    .btn { border:1px solid #334155; background:#0b1220; color:var(--text); padding:12px 14px; border-radius:12px; cursor:pointer; min-height:44px; }
    .btn.primary { border-color: var(--accent); box-shadow: inset 0 0 0 1px var(--accent); }
    .btn.ok { border-color: var(--ok); box-shadow: inset 0 0 0 1px var(--ok); }
    .btn.warn { border-color: var(--warn); box-shadow: inset 0 0 0 1px var(--warn); }
    .btn.bad { border-color: var(--bad); box-shadow: inset 0 0 0 1px var(--bad); }

    table { width:100%; border-collapse: collapse; }
    th, td { text-align:left; padding:10px; border-bottom: 1px dashed #263243; font-size: 15px; }
    th { font-weight:600; color: var(--muted); }
    tr:hover td { background: #0b1220; }

    .pill { padding:2px 8px; border-radius:999px; font-size:12px; border:1px solid #334155; }
    .pill.available{ color: var(--ok); border-color: var(--ok); }
    .pill.out{ color: var(--warn); border-color: var(--warn); }
    .pill.maintenance{ color: var(--bad); border-color: var(--bad); }
    .muted { color: var(--muted); }
    .hr { height:1px; background:#253044; margin:10px 0; }
    .hidden { display: none !important; }
    .roleBadge { font-size:12px; border:1px solid #334155; border-radius:999px; padding:4px 8px; margin-left:8px; }
    .clickable { cursor: pointer; }
    .empty { text-align:center; color:var(--muted); padding:16px; }

    .statusPill { display:inline-flex; align-items:center; gap:6px; padding:4px 10px; border:1px solid #334155; border-radius:999px; font-size:12px; }
    .statusPill.ok { border-color: var(--ok); color: var(--ok); }
    .statusPill.warn { border-color: var(--warn); color: var(--warn); }
    .statusPill.bad { border-color: var(--bad); color: var(--bad); }
    .cloudBanner { display:none; margin-top:8px; padding:8px 10px; border:1px solid #334155; border-radius:10px; background:#0b1220; font-size:13px; }

    /* Mobile card tables */
    @media (max-width: 640px){
      table.resp { border:0; }
      table.resp thead { display:none; }
      table.resp, table.resp tbody, table.resp tr, table.resp td { display:block; width:100%; }
      table.resp tr { margin:10px 0; border:1px solid #263243; border-radius:12px; overflow:hidden; }
      table.resp td { display:flex; justify-content:space-between; gap:12px; align-items:flex-start; padding:10px 12px; border-bottom:1px dashed #263243; }
      table.resp td:last-child { border-bottom:0; }
      table.resp td::before { content: attr(data-th); color: var(--muted); font-weight:600; flex: 0 0 42%; max-width: 42%; }
      table.resp td > * { flex: 1 1 58%; max-width: 58%; }
      .btn { width: 100%; }
    }
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>üè∑Ô∏è C150 Equipment Manager (No-QR MVP)</h1>
    <div class="tabs" id="tabs">
      <div class="tab active" data-target="inventory">Inventory</div>
      <div class="tab" data-target="maintenance">Maintenance</div>
      <div class="tab" data-target="logs">Logs</div>
      <div class="tab" data-target="requests">Athlete Request</div>
      <div class="tab" data-target="data">Export / Import</div>
    </div>
    <div class="row" style="margin-top:8px; align-items:center; gap:8px;">
      <span id="roleControls">
        <label class="muted">Role</label>
        <select id="roleSelect">
          <option value="coach">Coach</option>
          <option value="athlete">Athlete</option>
        </select>
        <span id="roleBadge" class="roleBadge">Athlete</span>
      </span>
      <span id="cloudStatus" class="statusPill warn">Cloud: Checking‚Ä¶</span>

      <button class="btn" id="btnForcePull" title="Fetch latest from cloud">Cloud Pull</button>
      <button class="btn" id="btnForcePush" title="Push local to cloud">Cloud Push</button>
      <button class="btn" id="btnCoachLogin">Coach Login</button>
      <button class="btn bad hidden" id="btnCoachLogout">Sign Out (Coach)</button>
    </div>
  </div>
</header>

<main>
  <!-- INVENTORY -->
  <section id="inventory" class="panel active">
    <div class="row" style="justify-content:space-between; align-items:end;">
      <div style="flex:1 1 auto; max-width:720px;">
        <div class="grid g3">
          <div>
            <label>Filter By Kind</label>
            <select id="fKind">
              <option value="">All</option>
              <option value="boat">Boat</option>
              <option value="oar">Oar</option>
              <option value="misc">Misc</option>
            </select>
          </div>
          <div>
            <label>Filter By Status</label>
            <select id="fStatus">
              <option value="">All</option>
              <option value="available">Available</option>
              <option value="out">Out</option>
              <option value="maintenance">Maintenance</option>
            </select>
          </div>
          <div>
            <label>Search</label>
            <input id="fSearch" placeholder="e.g. Hudson, 8+" />
          </div>
        </div>
      </div>
      <div>
        <button class="btn primary" id="btnNew">+ New Item</button>
      </div>
    </div>

    <div class="hr"></div>

    <div style="overflow:auto;">
      <table class="resp">
        <thead>
          <tr>
            <th>Kind</th>
            <th>Name</th>
            <th>Status</th>
            <th class="muted">Details</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="inventoryRows"></tbody>
      </table>
      <div id="inventoryEmpty" class="empty hidden">No Items Yet.</div>
    </div>
  </section>

  <!-- MAINTENANCE -->
  <section id="maintenance" class="panel">
    <div class="grid g3">
      <div>
        <label>Item</label>
        <select id="mntItem"></select>
      </div>
      <div>
        <label>Severity</label>
        <select id="mntSeverity">
          <option value="low">Low</option>
          <option value="med">Med</option>
          <option value="high">High</option>
        </select>
      </div>
      <div>
        <label>Assignee</label>
        <input id="mntAssignee" placeholder="e.g. Josh, Danny" />
      </div>
      <div>
        <label>Title</label>
        <input id="mntTitle" placeholder="e.g. Foot Stretcher Screws Stripped" />
      </div>
      <div style="grid-column:1/-1;">
        <label>Description</label>
        <textarea id="mntDesc" placeholder="What happened, what parts needed, links, etc."></textarea>
      </div>
      <div class="row">
        <button class="btn primary" id="btnMntCreate">+ Create Ticket</button>
      </div>
    </div>

    <div class="hr"></div>

    <div style="overflow:auto;">
      <table class="resp">
        <thead>
          <tr>
            <th>Item</th>
            <th>Severity</th>
            <th>Title</th>
            <th>Assignee</th>
            <th>Status</th>
            <th>Opened</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="mntRows"></tbody>
      </table>
      <div id="mntEmpty" class="empty hidden">No Tickets Yet.</div>
    </div>
  </section>

  <!-- LOGS -->
  <section id="logs" class="panel">
    <div class="row" style="justify-content:space-between;">
      <div class="muted">Most Recent First</div>
      <button class="btn" id="btnClearLogs">Clear Logs (Keeps Inventory)</button>
    </div>
    <div class="hr"></div>
    <div style="overflow:auto;">
      <table class="resp">
        <thead>
          <tr>
            <th>When</th>
            <th>Item</th>
            <th>Action</th>
            <th>Session</th>
            <th>Cond</th>
            <th>Note</th>
          </tr>
        </thead>
        <tbody id="logRows"></tbody>
      </table>
      <div id="logsEmpty" class="empty hidden">No Logs Yet.</div>
    </div>
  </section>

  <!-- REQUESTS -->
  <section id="requests" class="panel">
    <div class="grid g3">
      <div>
        <label>Athlete Name</label>
        <input id="reqAthlete" placeholder="Your Name" />
      </div>
      <div>
        <label>Boat</label>
        <select id="reqBoat"></select>
      </div>
      <div>
        <label>Seat</label>
        <select id="reqSeat"></select>
      </div>
      <div style="grid-column:1/-1;">
        <label>Complaint / Request</label>
        <textarea id="reqText" placeholder="Describe the issue or request (e.g., Seat 5 foot stretcher loose)"></textarea>
      </div>
      <div class="row">
        <button class="btn primary" id="btnReqSubmit">Submit Request</button>
      </div>
    </div>

    <div class="hr"></div>

    <div style="overflow:auto;">
      <table class="resp">
        <thead>
          <tr>
            <th>When</th>
            <th>Athlete</th>
            <th>Boat</th>
            <th>Seat</th>
            <th>Text</th>
            <th>Status</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="reqRows"></tbody>
      </table>
      <div id="reqEmpty" class="empty hidden">No Requests Yet.</div>
    </div>
  </section>

  <!-- DATA -->
  <section id="data" class="panel">
    <div class="row" style="gap:10px; flex-wrap:wrap;">
      <button class="btn" id="btnExport">Export JSON</button>
      <input type="file" id="fileImport" accept="application/json" />
      <button class="btn" id="btnImport">Import JSON</button>
      <button class="btn bad" id="btnWipe">Wipe ALL Data</button>
    </div>
    <p class="muted">Data is synced via Supabase when available; otherwise stored locally on this device.</p>
    <div id="cloudDiag" class="cloudBanner"></div>
    <pre id="exportBox" style="white-space:pre-wrap; background:#0b1220; border:1px solid #334155; border-radius:12px; padding:12px; display:none;"></pre>
  </section>
</main>

<!-- Supabase client -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
// ==============================
// Supabase config (shared DB)
// ==============================
const SUPABASE_URL = 'https://tglmzieiaokvohezxxlr.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRnbG16aWVpYW9rdm9oZXp4eGxyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI0NDU0NDUsImV4cCI6MjA3ODAyMTQ0NX0.O_0BZx4WFeC2N93-eeW0W76QZP84M1mCqrcDtqy1-Mc';
const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
const CLOUD_TABLE = 'equipment_data';  // one-row JSON store
const CLOUD_ROW_ID = 'singleton';
let CLOUD_ENABLED = false;             // flips true if cloud is reachable

let CLOUD_PULL_TIMER = null;
let CLOUD_LAST_SNAPSHOT = null; // stringified snapshot for change detection

function setCloudStatus(mode, message) {
  const pill = document.getElementById('cloudStatus');
  const diag = document.getElementById('cloudDiag');
  if (!pill) return;
  pill.classList.remove('ok','warn','bad');
  if (mode === 'on') { pill.classList.add('ok'); pill.textContent = 'Cloud: ON'; }
  else if (mode === 'off') { pill.classList.add('bad'); pill.textContent = 'Cloud: OFF'; }
  else { pill.classList.add('warn'); pill.textContent = 'Cloud: Checking‚Ä¶'; }
  if (diag) {
    if (message) { diag.style.display = 'block'; diag.textContent = message; }
    else { diag.style.display = 'none'; diag.textContent = ''; }
  }
}

function snapshot(dbObj){
  try { return JSON.stringify(dbObj); } catch { return null; }
}

function applyFromCloud(dataObj){
  try {
    if (!dataObj || typeof dataObj !== 'object') return false;
    const incoming = dataObj;
    const incomingSnap = snapshot(incoming);
    if (incomingSnap && incomingSnap !== CLOUD_LAST_SNAPSHOT) {
      db = incoming;
      CLOUD_LAST_SNAPSHOT = incomingSnap;
      saveLocal(); // keep offline copy
      refreshAll();
      return true;
    }
    return false;
  } catch { return false; }
}

// ==============================
// In-browser app state (db)
// ==============================
const STORE_KEY = 'c150_equipment_v1';
let db = {
  version: 1,
  equipment: [],
  logs: [],
  maintenance: [],
  requests: []
};

function uid() { return crypto.randomUUID ? crypto.randomUUID() : 'id-' + Math.random().toString(36).slice(2); }
function title(s){ return String(s||'').replace(/\b\w/g, c=>c.toUpperCase()); }
function setEmptyState(id, show){ const n=$(id); if(!n) return; n.classList.toggle('hidden', !show); }
const $ = sel => document.querySelector(sel);

function fmtDate(ts){ const d = new Date(ts); return d.toLocaleString(); }
function pill(status){ const s = String(status||'').toLowerCase(); return `<span class="pill ${s}">${title(s)}</span>`; }
function el(tag, attrs={}, ...children){
  const e = document.createElement(tag);
  Object.entries(attrs).forEach(([k,v])=>{
    if(k==='class') e.className=v;
    else if(k==='html') e.innerHTML=v;
    else if(k==='style') e.style.cssText=v;
    else e.setAttribute(k,v);
  });
  children.forEach(c=> e.append(c));
  return e;
}
function tdL(label, child, attrs={}) {
  const n = el('td', Object.assign({'data-th': label}, attrs));
  if (child instanceof Node) n.append(child);
  else n.textContent = child ?? '';
  return n;
}

// ==============================
// Persistence: local & cloud
// ==============================
function saveLocal(){ localStorage.setItem(STORE_KEY, JSON.stringify(db)); }
function loadLocal(){
  const raw = localStorage.getItem(STORE_KEY);
  if (raw) { try { db = JSON.parse(raw); } catch(e) { console.warn('Bad JSON, resetting'); } }
  if (!db.equipment?.length) seed();
}

// Cloud: single JSON row { id:'singleton', data: <db> }
async function cloudLoad(){
  try {
    const { data, error } = await supa.from(CLOUD_TABLE)
      .select('data')
      .eq('id', CLOUD_ROW_ID)
      .maybeSingle();

    if (error) {
      console.warn('Cloud load error:', error.message);
      setCloudStatus('off', `Cloud load error: ${error.message}. Using local storage.`);
      return false;
    }

    if (data && data.data) {
      applyFromCloud(data.data);
      setCloudStatus('on');
      return true;
    }

    // No row yet: seed locally and try to create it
    if (!db.equipment?.length) seed();
    const pushed = await cloudSave();
    if (pushed) {
      setCloudStatus('on', 'Initialized cloud with seed data.');
      CLOUD_LAST_SNAPSHOT = snapshot(db);
      return true;
    } else {
      setCloudStatus('off', 'Could not initialize cloud (RLS/policy?). Working locally.');
      return false;
    }
  } catch (err) {
    console.warn('Cloud load failed:', err);
    setCloudStatus('off', 'Cloud unreachable. Working locally.');
    return false;
  }
}
async function cloudSave(){
  try {
    const payload = { id: CLOUD_ROW_ID, data: db };
    const { error } = await supa.from(CLOUD_TABLE).upsert(payload);
    if (error) {
      console.warn('Cloud save error:', error.message);
      setCloudStatus('off', `Cloud save error: ${error.message}. Changes saved locally only.`);
      return false;
    }
    setCloudStatus('on');
    CLOUD_LAST_SNAPSHOT = snapshot(db);
    return true;
  } catch (err) {
    console.warn('Cloud save failed:', err);
    setCloudStatus('off', 'Cloud save failed. Changes saved locally only.');
    return false;
  }
}

// The save() used by the rest of the app
async function save(){
  // always keep a local copy for offline
  saveLocal();
  refreshAll();
  if(CLOUD_ENABLED){
    const ok = await cloudSave();
    if(!ok) console.warn('Cloud save skipped (error).');
  }
}

function startCloudPullLoop(){
  if (CLOUD_PULL_TIMER) clearInterval(CLOUD_PULL_TIMER);
  if (!CLOUD_ENABLED) return;
  CLOUD_PULL_TIMER = setInterval(async ()=>{
    try {
      const { data, error } = await supa.from(CLOUD_TABLE)
        .select('data')
        .eq('id', CLOUD_ROW_ID)
        .maybeSingle();
      if (!error && data && data.data) {
        applyFromCloud(data.data);
        setCloudStatus('on');
      }
    } catch (e) {
      console.warn('Cloud poll error:', e);
      setCloudStatus('off', 'Cloud poll error.');
    }
  }, 6000); // every 6s
}

async function boot(){
  // Try cloud first
  const ok = await cloudLoad();
  if (ok) {
    CLOUD_ENABLED = true;
    console.log('%cCloud sync: ON', 'color:#22c55e');
  } else {
    console.warn('Cloud not available. Using local storage only.');
    loadLocal();
    setCloudStatus('off');
  }
  // Ensure we always have something to show
  if (!db.equipment || db.equipment.length === 0) {
    seed();
    await save();
  } else {
    refreshAll();
  }
  startCloudPullLoop();
}

// ==============================
// Seed data
// ==============================
function seed(){
  db.equipment = [
    { id: uid(), kind:'boat', name:'Hudson USP 8+', status:'available',
      details:{boat_class:'8+', manufacturer:'Hudson', year:2021, weight_kg:95, rig_span_mm:1590, pitch_deg:2} },
    { id: uid(), kind:'boat', name:'Empacher 2-', status:'maintenance',
      details:{boat_class:'2-', manufacturer:'Empacher', year:2018, weight_kg:27, rig_span_mm:1580, pitch_deg:2} },
    { id: uid(), kind:'oar', name:'Croker P Set #3 (P/S)', status:'available',
      details:{side:'set', length_cm:286, inboard_cm:88, spoon:'Slick', set_name:'Set #3'} },
    { id: uid(), kind:'misc', name:'Cox Box Gold #12', status:'out',
      details:{category:'Cox Box', serial:'CBG-0012'} },
  ];
  db.logs = [];
  db.maintenance = [
    { id: uid(), equipmentId: null, severity:'med', title:'Port Rigger Hairline Crack',
      desc:'Monitor, likely replace after Dartmouth', assignee:'Danny', status:'open',
      openedAt: Date.now(), closedAt:null }
  ];
  db.requests = [];
}

// ==============================
// Role / coach auth (client-side)
// ==============================
const COACH_PW = 'ColumbiaLion$$1754';
const AUTH_KEY = 'c150_coach_auth';
const ROLE_KEY = 'c150_role';

function isCoachAuthed(){ return localStorage.getItem(AUTH_KEY) === '1'; }
function setCoachAuth(b){ localStorage.setItem(AUTH_KEY, b ? '1' : '0'); }
function getRole(){ return localStorage.getItem(ROLE_KEY) || 'athlete'; }
function setRole(r){ localStorage.setItem(ROLE_KEY, r); applyRoleUI(); }
function isCoachLike(){ return getRole()==='coach' && isCoachAuthed(); }

function promptCoachLogin(){
  const pwd = prompt('Enter Coach Password');
  if(pwd === COACH_PW){ setCoachAuth(true); setRole('coach'); alert('Coach mode enabled'); }
  else { alert('Incorrect password'); setRole('athlete'); }
}
function coachLogout(){ setCoachAuth(false); setRole('athlete'); alert('Signed out of Coach mode'); }

function applyRoleUI(){
  const roleControls = document.getElementById('roleControls');
  roleControls?.classList.toggle('hidden', !isCoachAuthed());
  const badge = document.getElementById('roleBadge');
  badge.textContent = title(isCoachLike() ? 'coach' : 'athlete');

  document.getElementById('btnNew')?.classList.toggle('hidden', !isCoachLike());
  document.getElementById('btnMntCreate')?.classList.toggle('hidden', !isCoachLike());
  const dataTab = Array.from(document.querySelectorAll('.tab')).find(t=> t.dataset.target==='data');
  if(dataTab) dataTab.classList.toggle('hidden', !isCoachLike());

  document.getElementById('btnCoachLogin')?.classList.toggle('hidden', isCoachAuthed());
  document.getElementById('btnCoachLogout')?.classList.toggle('hidden', !isCoachAuthed());

  const sel = document.getElementById('roleSelect');
  if(sel){ if(!isCoachAuthed()) sel.value = 'athlete'; else sel.value = getRole(); }

  renderInventory(); renderMaintenance(); renderRequests();
}

// ==============================
// Logging
// ==============================
function logPush({equipmentId=null, action='', session='', cond='', note=''}) {
  db.logs.unshift({ id: uid(), ts: Date.now(), equipmentId, action, session, cond, note });
}

// ==============================
// Inventory
// ==============================
let searchTimer;
function renderInventory(){
  const rows = $('#inventoryRows'); rows.innerHTML = '';
  const k = $('#fKind').value.trim();
  const s = $('#fStatus').value.trim();
  const q = $('#fSearch').value.trim().toLowerCase();
  const items = db.equipment
    .filter(it => !k || it.kind===k)
    .filter(it => !s || it.status===s)
    .filter(it => !q || it.name.toLowerCase().includes(q))
    .sort((a,b)=> a.kind.localeCompare(b.kind) || a.name.localeCompare(b.name));

  setEmptyState('#inventoryEmpty', items.length===0);

  items.forEach(it => {
    const detailStr = detailSummary(it);
    const actions = actionButtons(it);
    const tr = el('tr',{},
      tdL('Kind', title(it.kind)),
      tdL('Name', it.name),
      tdL('Status', el('span',{html:pill(it.status)})),
      tdL('Details', el('span',{class:'muted'}, detailStr)),
      tdL('Actions', actions)
    );
    rows.append(tr);
  });
}
function detailSummary(it){
  const d = it.details || {}; const k = it.kind;
  if(k==='boat') return `${d.boat_class?d.boat_class+' ':''}${d.manufacturer||''} ${d.year||''}`.trim();
  if(k==='oar')  return `${d.set_name||d.side||''} ${d.length_cm?d.length_cm+'cm':''} ${d.spoon||''}`.trim();
  if(k==='misc') return `${d.category||''} ${d.serial||''}`.trim();
  return '';
}
function actionButtons(it){
  const wrap = el('div', {class:'row', style:'width:100%;'});
  const edit = el('button', {class:'btn', style:'flex:1;'}, 'Edit');
  const del  = el('button', {class:'btn bad', style:'flex:1;'}, 'Delete');
  const status = el('button', {class:'btn ' + (it.status==='available'?'warn':it.status==='out'?'ok':'primary'), style:'flex:1;'},
                    it.status==='available'?'Set Out':it.status==='out'?'Set Available':'Set Available');

  edit.onclick = ()=>{ if(!isCoachLike()) return alert('Coach access required'); openItemModal(it.id); };
  del.onclick = ()=>{ if(!isCoachLike()) return alert('Coach access required');
    if(confirm('Delete This Item?')) { db.equipment = db.equipment.filter(x=>x.id!==it.id);
      logPush({equipmentId: it.id, action:'equipment_delete', note: it.name}); save(); } };
  status.onclick = ()=>{ if(!isCoachLike()) return alert('Coach access required');
    const newStatus = it.status==='out' ? 'available' : 'out';
    it.status = newStatus;
    logPush({equipmentId: it.id, action:'equipment_status', note: `${it.name} ‚Üí ${newStatus}`}); save(); };

  if(isCoachLike()) wrap.append(edit, del, status);
  else wrap.append(el('span',{class:'muted'}, 'View Only'));
  return wrap;
}

// Item modal
function openItemModal(id){
  if(!isCoachLike()) { alert('Coach access required'); return; }
  const existing = id ? db.equipment.find(e=>e.id===id) : null;
  const isEdit = !!existing;
  const item = existing ? JSON.parse(JSON.stringify(existing)) : { id:uid(), kind:'boat', name:'', status:'available', details:{} };

  const overlay = el('div', {style:'position:fixed;inset:0;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;z-index:50;'});
  const card = el('div', {style:'width:min(900px,92vw);max-height:90vh;overflow:auto;background:#0b1220;border:1px solid #334155;border-radius:14px;padding:16px;'});
  const titleBar = el('div', {class:'row', style:'justify-content:space-between;align-items:center;'},
    el('h3', {style:'margin:0;'}, isEdit?`Edit ${item.name}`:'New Item'), el('button',{class:'btn bad'},'√ó'));
  titleBar.lastChild.onclick = ()=> document.body.removeChild(overlay);

  const kindSel = el('select',{}, ...['boat','oar','misc'].map(k=>{const o=el('option',{},title(k)); o.value=k; if(item.kind===k)o.selected=true; return o;}));
  const nameIn = el('input',{value:item.name, placeholder:'Display Name e.g. Hudson USP 8+'});
  const statusSel = el('select',{}, ...['available','out','maintenance'].map(s=>{const o=el('option',{},title(s)); o.value=s; if(item.status===s)o.selected=true; return o;}));

  const fieldWrap = el('div', {class:'grid g3'});
  function renderFields(){
    fieldWrap.innerHTML='';
    const d = item.details || {};
    if(item.kind==='boat'){
      fieldWrap.append(
        field('Boat Class','boat_class', d.boat_class||'8+'),
        field('Manufacturer','manufacturer', d.manufacturer||''),
        field('Year','year', d.year||'', 'number'),
        field('Weight (kg)','weight_kg', d.weight_kg||'', 'number'),
        field('Span (mm)','rig_span_mm', d.rig_span_mm||'', 'number'),
        field('Pitch (deg)','pitch_deg', d.pitch_deg||'', 'number')
      );
    } else if(item.kind==='oar'){
      fieldWrap.append(
        field('Side or "Set"','side', d.side||'set'),
        field('Length (cm)','length_cm', d.length_cm||'', 'number'),
        field('Inboard (cm)','inboard_cm', d.inboard_cm||'', 'number'),
        field('Spoon','spoon', d.spoon||''),
        field('Set Name','set_name', d.set_name||'')
      );
    } else {
      fieldWrap.append(
        field('Category','category', d.category||'Cox Box'),
        field('Serial/ID','serial', d.serial||'')
      );
    }
  }
  function field(labelTxt, key, val, type='text'){
    const wrap = el('div',{});
    wrap.append(el('label',{},labelTxt));
    const inp = el('input',{value:val}); if(type==='number') inp.type='number';
    inp.oninput = ()=> { item.details = item.details||{}; item.details[key] = inp.value; };
    wrap.append(inp); return wrap;
  }
  kindSel.onchange = ()=> { item.kind = kindSel.value; renderFields(); };
  nameIn.oninput = ()=> item.name = nameIn.value;
  statusSel.onchange = ()=> item.status = statusSel.value;

  renderFields();

  const saveBtn = el('button',{class:'btn primary'}, isEdit?'Save Changes':'+ Add Item');
  saveBtn.onclick = ()=>{
    if(!item.name.trim()) return alert('Name Required');
    if(isEdit){
      const ix = db.equipment.findIndex(e=>e.id===item.id); db.equipment[ix] = item;
      logPush({equipmentId:item.id, action:'equipment_edit', note:item.name});
    } else {
      db.equipment.push(item);
      logPush({equipmentId:item.id, action:'equipment_add', note:item.name});
    }
    save(); document.body.removeChild(overlay);
  };

  card.append(
    titleBar,
    el('div',{class:'grid g3', style:'margin-top:10px;'},
      mkL('Kind',kindSel), mkL('Name',nameIn), mkL('Status',statusSel)
    ),
    el('div',{class:'hr'}),
    fieldWrap,
    el('div',{class:'row', style:'margin-top:12px;'}, saveBtn)
  );
  overlay.append(card); document.body.appendChild(overlay);
}
function mkL(lbl, node){ const w = el('div',{}); w.append(el('label',{},lbl), node); return w; }

// ==============================
// Select fillers
// ==============================
function refillSelectors(){
  const opts = db.equipment.map(e=>({id:e.id, name:`${e.name} ‚Äî ${title(e.kind)}`}));
  function fill(sel){ if(!sel) return; sel.innerHTML=''; opts.forEach(o=> sel.append(el('option',{value:o.id}, o.name))); }
  fill($('#mntItem'));
}

// ==============================
// Athlete Requests
// ==============================
function seatCountForBoat(boat){
  const cls = (boat?.details?.boat_class || boat?.details?.class || boat?.name || '').toString();
  const m = cls.match(/(1|2|4|8)/);
  let n = m ? parseInt(m[1],10) : 8;
  return Math.max(1, Math.min(8, n));
}
function hasCoxSeat(boat){ const cls = (boat?.details?.boat_class || boat?.name || '').toString(); return cls.includes('+'); }
function refillRequestSelectors(){
  const boatSel = document.getElementById('reqBoat');
  const seatSel = document.getElementById('reqSeat');
  if(!boatSel || !seatSel) return;
  boatSel.innerHTML = '';
  db.equipment.filter(e=> e.kind==='boat').forEach(b=>{
    const o = document.createElement('option'); o.value=b.id; o.textContent=b.name; boatSel.append(o);
  });
  function buildSeats(){
    seatSel.innerHTML='';
    const boat = db.equipment.find(e=> e.id===boatSel.value);
    const n = seatCountForBoat(boat);
    for(let i=1;i<=n;i++){ const o=document.createElement('option'); o.value=String(i); o.textContent=`Seat ${i}`; seatSel.append(o); }
    if(hasCoxSeat(boat)){ const o=document.createElement('option'); o.value='cox'; o.textContent='Cox'; seatSel.append(o); }
  }
  boatSel.onchange = buildSeats;
  if(boatSel.value){ buildSeats(); } else { seatSel.innerHTML=''; }
}

function submitRequest(){
  const athlete = document.getElementById('reqAthlete').value.trim();
  const boatId = document.getElementById('reqBoat').value;
  const seat = document.getElementById('reqSeat').value;
  const text = document.getElementById('reqText').value.trim();
  if(!boatId) return alert('Please Select A Boat');
  if(!seat) return alert('Please Select A Seat');
  if(!text) return alert('Please Describe The Issue');
  db.requests.unshift({ id: uid(), createdAt: Date.now(), athlete, boatId, seat, text, status:'open' });
  logPush({equipmentId:boatId, action:'request_submit', note:`Seat ${seat}: ${text.slice(0,60)}`});
  save();
  document.getElementById('reqText').value='';
}

function renderRequests(){
  const tbody = document.getElementById('reqRows'); if(!tbody) return; tbody.innerHTML='';
  setEmptyState('#reqEmpty', db.requests.length===0);
  db.requests.forEach(r=>{
    const boat = db.equipment.find(e=> e.id===r.boatId);
    const actions = el('div',{class:'row', style:'width:100%;'});
    if(isCoachLike()){
      const mkMaint = el('button',{class:'btn primary', style:'flex:1;'}, 'Make Ticket');
      mkMaint.onclick = ()=>{
        db.maintenance.unshift({ id:uid(), equipmentId:r.boatId, severity:'med', title:`Athlete Req (Seat ${r.seat})`, desc:r.text, assignee:'', status:'open', openedAt:Date.now(), closedAt:null });
        r.status='escalated';
        logPush({equipmentId:r.boatId, action:'request_escalate', note:`Seat ${r.seat}`});
        save();
      };
      const done = el('button',{class:'btn ok', style:'flex:1;'}, 'Resolve');
      done.onclick = ()=>{ r.status='done'; logPush({equipmentId:r.boatId, action:'request_resolve', note:`Seat ${r.seat}`}); save(); };
      const del = el('button',{class:'btn bad', style:'flex:1;'}, 'Delete');
      del.onclick = ()=>{ if(confirm('Delete Request?')){ db.requests = db.requests.filter(x=>x.id!==r.id); logPush({equipmentId:r.boatId, action:'request_delete', note:`Seat ${r.seat}`}); save(); } };
      actions.append(mkMaint, done, del);
    } else {
      actions.append(el('span',{class:'muted'}, 'Submitted'));
    }

    const tr = el('tr',{},
      tdL('When', fmtDate(r.createdAt)),
      tdL('Athlete', r.athlete||''),
      tdL('Boat', boat?boat.name:'(Deleted Boat)'),
      tdL('Seat', r.seat),
      tdL('Text', r.text),
      tdL('Status', title(r.status)),
      tdL('Actions', actions)
    );
    tbody.append(tr);
  });
}

// ==============================
// Logs
// ==============================
function renderLogs(){
  const tbody = $('#logRows'); tbody.innerHTML='';
  setEmptyState('#logsEmpty', db.logs.length===0);
  db.logs.forEach(l=>{
    const item = db.equipment.find(e=>e.id===l.equipmentId);
    const tr = el('tr',{},
      tdL('When', fmtDate(l.ts)),
      tdL('Item', item?item.name:'(N/A)'),
      tdL('Action', title(l.action||'')),
      tdL('Session', l.session||''),
      tdL('Cond', String(l.cond||'')),
      tdL('Note', l.note||'')
    );
    tbody.append(tr);
  });
}

// ==============================
// Maintenance
// ==============================
function createTicket(){
  if(!isCoachLike()) { alert('Coach access required'); return; }
  const equipmentId = $('#mntItem').value; const item = db.equipment.find(e=>e.id===equipmentId);
  const t = {
    id: uid(), equipmentId,
    severity: $('#mntSeverity').value,
    title: $('#mntTitle').value.trim()||`Issue: ${item?.name||''}`,
    desc: $('#mntDesc').value.trim(),
    assignee: $('#mntAssignee').value.trim(),
    status: 'open', openedAt: Date.now(), closedAt: null
  };
  db.maintenance.unshift(t);
  logPush({equipmentId, action:'ticket_create', note:t.title});
  save();
  $('#mntTitle').value=''; $('#mntDesc').value=''; $('#mntAssignee').value='';
}

function renderMaintenance(){
  const tbody = $('#mntRows'); tbody.innerHTML='';
  setEmptyState('#mntEmpty', db.maintenance.length===0);
  db.maintenance.forEach(t=>{
    const item = db.equipment.find(e=>e.id===t.equipmentId);
    const actions = maintActions(t);
    const tr = el('tr', {class:'clickable'});
    tr.append(
      tdL('Item', item?item.name:'(Deleted Item)'),
      tdL('Severity', title(t.severity)),
      tdL('Title', t.title),
      tdL('Assignee', t.assignee||''),
      tdL('Status', title(t.status)),
      tdL('Opened', fmtDate(t.openedAt)),
      tdL('Actions', actions)
    );
    tr.addEventListener('click', (ev)=>{
      if(ev.target.closest('button')) return;
      openTicketModal(t.id);
    });
    tbody.append(tr);
  });
}
function maintActions(t){
  const wrap = el('div', {class:'row', style:'width:100%;'});
  const view = el('button', {class:'btn', style:'flex:1;'}, 'View');
  const done = el('button', {class:'btn ok', style:'flex:1;'}, 'Mark Done');
  const reopen = el('button', {class:'btn warn', style:'flex:1;'}, 'Reopen');
  const del = el('button', {class:'btn bad', style:'flex:1;'}, 'Delete');

  view.onclick = ()=> openTicketModal(t.id);
  done.onclick = ()=>{ if(!isCoachLike()) return alert('Coach access required'); t.status='done'; t.closedAt=Date.now(); logPush({equipmentId:t.equipmentId, action:'ticket_done', note:t.title}); save(); };
  reopen.onclick = ()=>{ if(!isCoachLike()) return alert('Coach access required'); t.status='open'; t.closedAt=null; logPush({equipmentId:t.equipmentId, action:'ticket_reopen', note:t.title}); save(); };
  del.onclick = ()=>{ if(!isCoachLike()) return alert('Coach access required'); if(confirm('Delete Ticket?')){ db.maintenance = db.maintenance.filter(x=>x.id!==t.id); logPush({equipmentId:t.equipmentId, action:'ticket_delete', note:t.title}); save(); } };

  wrap.append(view, done, reopen, del);
  return wrap;
}
function openTicketModal(ticketId){
  const t = db.maintenance.find(x=>x.id===ticketId);
  const item = db.equipment.find(e=>e.id===t?.equipmentId);
  if(!t) return;

  const overlay = el('div', {style:'position:fixed;inset:0;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;z-index:60;'});
  const card = el('div', {style:'width:min(700px,92vw);max-height:90vh;overflow:auto;background:#0b1220;border:1px solid #334155;border-radius:14px;padding:16px;'});

  const head = el('div', {class:'row', style:'justify-content:space-between;align-items:center;'},
    el('h3',{style:'margin:0;'}, 'Ticket Details'),
    el('button',{class:'btn bad'},'√ó')
  );
  head.lastChild.onclick = ()=> document.body.removeChild(overlay);

  const grid = el('div',{class:'grid g2', style:'margin-top:10px;'});
  grid.append(
    mkL('Item', el('div',{}, item?item.name:'(Deleted Item)')),
    mkL('Severity', el('div',{}, title(t.severity))),
    mkL('Title', el('div',{}, t.title)),
    mkL('Assignee', el('div',{}, t.assignee||'')),
    mkL('Status', el('div',{}, title(t.status))),
    mkL('Opened', el('div',{}, fmtDate(t.openedAt))),
  );
  if(t.closedAt){ grid.append(mkL('Closed', el('div',{}, fmtDate(t.closedAt)))); }

  const descBox = el('div', {style:'margin-top:12px;'});
  descBox.append(el('label',{}, 'Description'));
  const desc = el('div', {style:'white-space:pre-wrap;border:1px solid #334155;border-radius:10px;padding:12px;background:#0b1220;'}, t.desc||'(No Description)');
  descBox.append(desc);

  const actions = el('div', {class:'row', style:'margin-top:12px;'});
  if(isCoachLike()){
    const done = el('button', {class:'btn ok', style:'flex:1;'}, 'Mark Done');
    const reopen = el('button', {class:'btn warn', style:'flex:1;'}, 'Reopen');
    const del = el('button', {class:'btn bad', style:'flex:1;'}, 'Delete');
    done.onclick = ()=>{ t.status='done'; t.closedAt=Date.now(); logPush({equipmentId:t.equipmentId, action:'ticket_done', note:t.title}); save(); document.body.removeChild(overlay); };
    reopen.onclick = ()=>{ t.status='open'; t.closedAt=null; logPush({equipmentId:t.equipmentId, action:'ticket_reopen', note:t.title}); save(); document.body.removeChild(overlay); };
    del.onclick = ()=>{ if(confirm('Delete Ticket?')){ db.maintenance = db.maintenance.filter(x=>x.id!==t.id); logPush({equipmentId:t.equipmentId, action:'ticket_delete', note:t.title}); save(); document.body.removeChild(overlay); } };
    actions.append(done, reopen, del);
  }

  card.append(head, grid, descBox, actions);
  overlay.append(card);
  document.body.appendChild(overlay);
}
function mkL(lbl, node){ const w = el('div',{}); w.append(el('label',{},lbl), node); return w; }

// ==============================
// Data IO
// ==============================
function exportJSON(){ const data = JSON.stringify(db, null, 2); const box = $('#exportBox'); box.style.display='block'; box.textContent = data; }
function importJSON(file){
  const reader = new FileReader();
  reader.onload = async e => {
    try{
      const incoming = JSON.parse(e.target.result);
      if(!incoming.equipment) throw new Error('Invalid file');
      db = incoming;
      await save();
      alert('Import Successful');
    } catch(err){ alert('Import Failed: '+err.message); }
  };
  reader.readAsText(file);
}
async function wipeAll(){
  if(confirm('This Deletes ALL Data. Proceed?')){
    localStorage.removeItem(STORE_KEY);
    db={version:1,equipment:[], logs:[], maintenance:[], requests:[]}; seed(); await save();
  }
}

// ==============================
// Events
// ==============================
document.getElementById('btnNew').onclick = ()=> openItemModal();
['#fKind','#fStatus'].forEach(sel=> $(sel).addEventListener('input', renderInventory));
document.getElementById('fSearch').addEventListener('input', ()=>{ clearTimeout(searchTimer); searchTimer = setTimeout(renderInventory, 150); });
document.getElementById('btnMntCreate').onclick = createTicket;
document.getElementById('btnExport').onclick = exportJSON;
document.getElementById('btnImport').onclick = ()=>{ const f = document.getElementById('fileImport').files?.[0]; if(!f) return alert('Choose A JSON File To Import'); importJSON(f); };
document.getElementById('btnWipe').onclick = ()=>{ wipeAll(); };
document.getElementById('btnClearLogs').onclick = async ()=>{ if(confirm('Clear All Logs?')){ db.logs=[]; await save(); } };
// Requests
document.getElementById('btnReqSubmit')?.addEventListener('click', submitRequest);
// Role select
document.getElementById('roleSelect')?.addEventListener('change', (e)=>{
  const val = e.target.value;
  if(val==='coach' && !isCoachAuthed()){ promptCoachLogin(); } else { setRole(val); }
});
// Coach login/logout buttons
document.getElementById('btnCoachLogin')?.addEventListener('click', promptCoachLogin);
document.getElementById('btnCoachLogout')?.addEventListener('click', coachLogout);

// Cloud manual controls
const btnPull = document.getElementById('btnForcePull');
if (btnPull) btnPull.addEventListener('click', async ()=>{ await cloudLoad(); refreshAll(); });
const btnPush = document.getElementById('btnForcePush');
if (btnPush) btnPush.addEventListener('click', async ()=>{ await cloudSave(); });

// Tabs
Array.from(document.querySelectorAll('.tab')).forEach(t=>{
  t.onclick = ()=>{
    document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
    document.querySelectorAll('section.panel').forEach(x=>x.classList.remove('active'));
    t.classList.add('active');
    document.getElementById(t.dataset.target).classList.add('active');
  };
});

// Boot
applyRoleUI();
setCloudStatus('checking');
boot().then(()=>{ refillRequestSelectors(); refillSelectors(); });
</script>
</body>
</html>